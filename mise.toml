[tools]
python = "3.13"
uv = "latest"
prek = "latest"
gomigrate = "latest"
age = "latest"
fnox = "latest"
"npm:httpyac" = "latest"

[env]
# k2c-agents
ENV = "local"
DATABASE_URL = "postgresql://postgres:password@localhost:4718/k2c_agents?sslmode=disable"
OPENAI_AGENTS_DISABLE_TRACING = "1"
S3_ENDPOINT = "http://localhost:4900"
S3_ACCESS_KEY = "minioadmin"
S3_SECRET_KEY = "minioadmin"
S3_BUCKET = "k2c-agents"
S3_REGION = "us-east-1"
INDEXER_API_BASE_URL = "http://localhost:8003"
NEO4J_URI = "bolt://localhost:7687"
NEO4J_USER = "neo4j"
NEO4J_PASSWORD = "k2cneo4j"
NEO4J_DATABASE = "neo4j"
INDEXER_RUN_AGENT = "0"
AGENT_INTERVAL_SECONDS = "20"
OPENAI_MODEL = "gpt-5.2"
# k2c-collector
API_ENDPOINT = "http://localhost:8001/event"
CAPTURE_INTERVAL_SECONDS = "10"
IMAGE_FORMAT = "png"
IMAGE_QUALITY = "100"

[tasks."docker-compose.up"]
run = "docker-compose up -d"

[tasks."agents.install"]
dir = "{{cwd}}/k2c-agents"
run = "prek install && uv sync"

[tasks."db.migrate"]
run = '''
migrate --path ./migrations --database "${DATABASE_URL}" up
'''

[tasks."agents.fmt"]
dir = "{{cwd}}/k2c-agents"
run = "uv run ruff format ."
[tasks."collector.fmt"]
dir = "{{cwd}}/k2c-collector"
run = "uv run ruff format ."

[tasks."collector"]
dir = "{{cwd}}/k2c-collector"
run = "uv run python src/__main__.py"
depends = ["collector.install"]
[tasks."collector.install"]
dir = "{{cwd}}/k2c-collector"
run = "uv sync"

[tasks."dev"]
dir = "{{cwd}}/k2c-agents"
depends = [
  "agents.install",
  "agents.preprocess.server",
  "agents.preprocess.manager",
  "indexer.install",
  "indexer.start",
  "collector"
]

[tasks."agents.preprocess.server"]
dir = "{{cwd}}/k2c-agents"
run = '''
uv run k2c-collector-proxy
'''

[tasks."agents.preprocess.manager"]
dir = "{{cwd}}/k2c-agents"
run = '''
uv run k2c-preprocess-agent
'''

[tasks."indexer.install"]
dir = "{{cwd}}/k2c-indexer"
run = "uv sync"

[tasks."indexer.agent"]
dir = "{{cwd}}/k2c-indexer"
run = '''
uv run k2c-indexer-agent
'''

[tasks."indexer.start"]
dir = "{{cwd}}/k2c-indexer"
run = '''
INDEXER_RUN_AGENT=1 uv run k2c-indexer-server
'''

[tasks."indexer.test.http"]
dir = "{{cwd}}/k2c-indexer"
run = '''
httpyac send --all ./tests/httpyac/*.http
'''

[tasks."agents.test.http"]
dir = "{{cwd}}/k2c-agents"
run = '''
httpyac send --all ./tests/http/*.http
'''
